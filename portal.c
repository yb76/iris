
#include <stdio.h>
#include <string.h>
#include <stdlib.h>
#include <sys/socket.h>
#include <sys/types.h>
#include <time.h>
#include <sys/time.h>
#include <sys/select.h>
#include <netinet/in.h>
#include <arpa/inet.h>
#include <netdb.h>
#include <unistd.h>
#include <errno.h>

#include "libxml/xmlreader.h"
#include "libxml/xmlwriter.h"
#include "macro.h"

#ifndef MAXBUFFERLEN
#define MAXBUFFERLEN 1024*100
#endif

char * GetLocalTimeStr( char * timestr )
{
	time_t rawtime;
	struct tm * ptm;
	struct tm temp;

	time ( &rawtime );
	ptm = localtime_r ( &rawtime ,&temp);

	/* YYYYMMDDHHMMSS */
	sprintf( timestr, "%04d%02d%02d%02d%02d%02d",
		ptm->tm_year + 1900 ,
		ptm->tm_mon + 1,
		ptm->tm_mday,
		ptm->tm_hour,
		ptm->tm_min,
		ptm->tm_sec );

	return( timestr );
}

int packXmlToConfigServer(char *xmlbuffer,int msgtype, T_WEBREQUEST* inreq ) 
{

    int rc = 0;
    int ok = 0;
    char currenttime[30];
	
    xmlTextWriterPtr writer;
    xmlBufferPtr buf;
    GetLocalTimeStr( currenttime);
	
    buf = xmlBufferCreate();
    if (buf == NULL) {
        logNow(" Error creating the xml buffer\n");
        return(-1);
    }

    writer = xmlNewTextWriterMemory(buf, 0);
    if (writer == NULL) {
        logNow(" Error creating the xml writer\n");
        return(-1);
    }

    xmlTextWriterSetIndent(writer, 1);

    ok = xmlTextWriterStartDocument(writer, NULL, NULL, NULL);
    if (ok < 0) {
        logNow ( "Error at xmlTextWriterStartDocument\n");
        xmlFreeTextWriter(writer);
		xmlBufferFree(buf);
		return(-1);
    }
	
    T_WEBREQUEST *webreq = inreq;
    {
	// VX680 & VX6803G
	// Disabled 13/08/2014
	if( strncmp(webreq->model,"VX680",5) ==0) strcpy(webreq->model,"VX680");
    }

    switch( msgtype ) {
		case WEBREQUEST_MSGTYPE_HEARTBEAT: 
			ok = 
				StartElement(writer, "terminalConnectionRequest")
			&&  WriteAttribute(writer, "connectTime", currenttime)
			&& WriteElement(writer, "serialNumber", webreq->serialNumber ) //TODO
			&& WriteElement(writer, "model", webreq->model )
			&& WriteElement(writer, "returnACK", webreq->result )
			&& WriteElement(writer, "jsontext", webreq->jsontext );
			
			break;
		case WEBREQUEST_MSGTYPE_GETCONFIG:
			ok = 
				StartElement(writer, "terminalInitializationRequest")
			&& WriteElement(writer, "Tid", webreq->tid ) 
			&& WriteElement(writer, "serialNumber", webreq->serialNumber) ;
			if( webreq->appname[0] ) ok = ok && WriteElement(writer, "appName", webreq->appname ) ;
			if( webreq->objectname[0]) ok = ok && WriteElement(writer, "objectName", webreq->objectname );
			

			break;
		case WEBREQUEST_MSGTYPE_TRANSLOG:
				break;
		case WEBREQUEST_MSGTYPE_TRADEOFFER: 
			ok = 
				StartElement(writer, "terminalMsgRequest")
			&&  WriteAttribute(writer, "connectTime", currenttime)
			&& WriteElement(writer, "serialNumber", webreq->serialNumber ) //TODO
			&& WriteElement(writer, "jsontext", webreq->jsontext ) //TODO
			;
			break;
		case WEBREQUEST_MSGTYPE_IPAYTRANS: 
			ok = 
				StartElement(writer, "paymentTransactionRequest")
			&&  WriteAttribute(writer, "transTime", webreq->transTime)
			&& WriteElement(writer, "Tid", webreq->tid ) 
			&& WriteElement(writer, "serialNumber", webreq->serialNumber) 
			&& WriteElement(writer, "amount", webreq->amount) 
			&& WriteElement(writer, "last4Digits", webreq->last4Digits) 
			&& WriteElement(writer, "reponseCode", webreq->reponseCode) 
			&& WriteElement(writer, "authID", webreq->authID) 
			&& WriteElement(writer, "cardType", webreq->cardType) 
			;
			break;
		default:
			break;
	}
	
   
    ok = ok && ( xmlTextWriterEndDocument(writer) >= 0);
    if(!ok) 
		{
		logNow(" Error at generating xml\n");
		rc = -1;
		}
    else {
		strcpy( xmlbuffer, (const char *)buf->content );
		logNow( "WEBCONFIG request buffer=[%s]\n", xmlbuffer);
		rc = 0;
    }
    if(webreq->jsontext) {
	free(webreq->jsontext);
	webreq->jsontext=NULL;
    }
    xmlFreeTextWriter(writer);
    xmlBufferFree(buf);

    return(rc);

}

int unpackXmlHB(xmlTextReaderPtr  reader, char *xmlbuffer, T_WEBRESP *hb)
{
	char name[50]="";
	char value[200];
	int depth=0,rootdepth=0;
	char * ptr_start = NULL;
	char * ptr_end = NULL;
	char *jsonptr =NULL;

	logNow( "unpack xml \n");

	getNextElement(reader,name,&depth);
	if( depth == rootdepth &&
			(strcmp(name, "terminalConnectionResponse") ==0 ||
			strcmp(name, "terminalMsgResponse") ==0 ||
			strcmp(name, "paymentTransactionResponse") ==0 ||
			strcmp(name, "terminalInitializationResponse") ==0))
	{
		getNextElement(reader,name,&depth);
		if( depth==rootdepth+1 && strcmp(name,"serialNumber")==0)
		{
			getElementTextValue(reader,value);
			getNextElement(reader,name,&depth);
		}

		if( depth==rootdepth+1 && strcmp(name,"model")==0)
		{
			getElementTextValue(reader,value);
			getNextElement(reader,name,&depth);
		}

		if( depth==rootdepth+1 && strcmp(name,"NextMsg")==0)
		{
			getElementTextValue(reader,value);
			hb->nextmsg=value[0];			
			logNow( "unpack xml nextmsg[%c] \n", hb->nextmsg);
			getNextElement(reader,name,&depth);
		}

		ptr_start = strstr(xmlbuffer,"<jsontext>" );
		if(ptr_start) ptr_start += strlen( "<jsontext>");
		ptr_end = strstr( xmlbuffer,"</jsontext>" );
		if( ptr_start && ptr_end  ) {
			int length = ptr_end - ptr_start;
			hb->jsontext = (char*) calloc( length + 1,1);
			memcpy( hb->jsontext, ptr_start, length );
			*(hb->jsontext + length) = '\0';

			logNow( "unpack xml json[%s] \n", hb->jsontext);
		}

	}


	if(hb->jsontext && strlen(hb->jsontext)) {
		char *find=NULL,*end=NULL;
		char *p_start = hb->jsontext;
		char entity[10],entity_c;

		strcpy(entity, "&lt;");	entity_c = '<';
		while( (find = strstr(p_start,entity)) != NULL ) {
			end = find + strlen(entity);
			sprintf(find,"%c%s",entity_c,end);
		}
		strcpy(entity, "&gt;");	entity_c = '>';
		while( (find = strstr(p_start,entity)) != NULL ) {
			end = find + strlen(entity);
			sprintf(find,"%c%s",entity_c,end);
		}
		strcpy(entity, "&amp;");	entity_c = '&';
		while( (find = strstr(p_start,entity)) != NULL ) {
			end = find + strlen(entity);
			sprintf(find,"%c%s",entity_c,end);
		}
		strcpy(entity, "&apos;");	entity_c = '\'';
		while( (find = strstr(p_start,entity)) != NULL ) {
			end = find + strlen(entity);
			sprintf(find,"%c%s",entity_c,end);
		}
		strcpy(entity, "&quot;");	entity_c = '"';
		while( (find = strstr(p_start,entity)) != NULL ) {
			end = find + strlen(entity);
			sprintf(find,"%c%s",entity_c,end);
		}
	}

	return(0);
}

int unpackXmlFromPortal(char *xmlbuffer,int msgtype, T_WEBRESP* resp )
{

	xmlTextReaderPtr reader;
	int ok = 0;

	reader = xmlReaderForMemory( xmlbuffer,
			strlen(xmlbuffer), NULL /*URL*/, NULL/*encoding*/,0/*options*/);
	if(reader == NULL)
	{
		logNow(" Error: xmlReaderForMemory failed \n" );
		return(-1);
	}

	switch( msgtype ) {
		case WEBREQUEST_MSGTYPE_HEARTBEAT: 
		case WEBREQUEST_MSGTYPE_GETCONFIG:
		case WEBREQUEST_MSGTYPE_TRADEOFFER:
		case WEBREQUEST_MSGTYPE_IPAYTRANS:
		default:
			ok = unpackXmlHB( reader,xmlbuffer, resp);		
			break;
	}

	xmlFreeTextReader(reader);

	//One should call xmlCleanupParser() only when the process has finished using the library
	return(ok);

}

int tcp_connect(char *host , int port)
{

    struct sockaddr_in dst;
    int len; 
    int	sfd=0;
    struct hostent* pHE = gethostbyname(host);

    if (pHE == 0) {
            return (-1);
    }
    dst.sin_addr.s_addr = *((u_long*)pHE->h_addr_list[0]);
    dst.sin_family = AF_INET;
    dst.sin_port = htons(port);
    len = sizeof(dst);

    /*Create socket & err check*/
    sfd = socket(AF_INET, SOCK_STREAM, 0);
    if (sfd < 0) {
	logNow("ERROR tcp_connect >> socket()\n");
	return -1;
    }

    if ((connect(sfd, (struct sockaddr *)&dst, len)) < 0) {
	logNow("ERROR tcp_connect >> connect(),%s,%d\n",host,port);
	return -1;
    }

    return sfd;


}

int tcp_send (int sd,int nlen,char *str) 
{
    int nSentBytes = 0;
    while (nSentBytes < nlen) {
        int nTemp = send(sd, str + nSentBytes,nlen - nSentBytes, MSG_NOSIGNAL);
        if (nTemp > 0) nSentBytes += nTemp;
        else {
		break;
	}
    }

    return(nSentBytes);
}

int tcp_recv(int sd, int len, char *buff)
{
	int left = len;
	int nTotal = 0;
	char *ptr = buff;

	if(len <=0) return(0);

	do {
		int nReadBytes = recv(sd, ptr, left, 0);
		if(nReadBytes<=0) break;
		else {
			nTotal = nTotal + nReadBytes;
			ptr = ptr + nReadBytes;
			left = len - nTotal;
		}
	} while(left>0);

	return(nTotal);
}

int tcp_close(int sd)
{
	close(sd);
	return(0);
}

int sendXmlToPortal(int sd,int msgtype,T_WEBREQUEST* inreq, T_WEBRESP* xmlresp)
{
	char buff[10240];
	char acLength[6];
	int length ;
	int timeout= 10;
	int iret = 0;
	char *resp = NULL;

	memset(buff,0,sizeof(buff));

	if(inreq && inreq->serialNumber[0]!='\0') iret = packXmlToConfigServer( buff,msgtype,inreq );
	if(iret<0) {
		logNow("pack xml failed\n");
		return(-1);
	}

if(1) //PORTAL TESTING
	{
		char temp[50];
		if(strlen(buff)) iret = tcp_send ( sd, strlen(buff)+1, buff ); // boyang TESTING
		if(iret<0) {
			logNow("ERROR socket_send to xml config server failed\n");
			return(-1);
		}
		logNow(	"\n xml SENT***\n");
	
		if(xmlresp == NULL) return (0);

		memset(acLength,0,sizeof(acLength));
		iret = tcp_recv( sd, 5, acLength);
		if(iret<0) {
			logNow("ERROR socket_recv header from xml config server failed\n");
			return(-1);
		} else {
			logNow("socket_recv header from xml[%s]\n", acLength);
		}


		length = atoi(acLength);
		resp = (char*) calloc( length + 1 ,1);
		iret = tcp_recv( sd, length, resp);
		if(iret<=0) {
			logNow("ERROR socket_recv from xml config server failed\n");
			free(resp);
			return(-1);
		} else {
			logNow("socket_recv from xml[%s]\n", resp);
		}

		logNow(	"\n xml RECV***");
	}
else
{
static int testmsg = 0;
resp = (char *)calloc(10240,1);

	if(testmsg == 0 ) {
strcpy(resp,"<?xml version=\"1.0\"?>");
strcat(resp,"<terminalConnectionResponse>");
strcat(resp,"<serialNumber>00</serialNumber>");
strcat(resp,"<model>TEST</model>");
strcat(resp,"<NextMsg>1</NextMsg>\n");
strcat(resp,"<jsontext>{TYPE:FILE_PART,NEXTMSG:1,NAME:CPAT_TEST,INDEX:000,ENCODE:HEX,DATALEN:8192,DATA:7b545950453a444154412c4e414d453a435041545f414c4c2c47524f55503a5742432c56455253494f4e3a312e302c505245464958303a3330464646464646464630322c434f4445303a32342c505245464958313a33344646464646464630312c434f4445313a32322c505245464958323a33354646464646464630362c434f4445323a32322c505245464958333a33364646464646464630322c434f4445333a32322c505245464958343a33374646464646464630312c434f4445343a32322c505245464958353a33384646464646464630322c434f4445353a32322c505245464958363a33394646464646464630322c434f4445363a32322c505245464958373a34303239383046464630352c434f4445373a32322c505245464958383a34303831373746464630352c434f4445383a32322c505245464958393a34303933343946464630352c434f4445393a32322c50524546495831303a3431343732364646464630352c434f444531303a32322c50524546495831313a34323933313746464630352c434f444531313a32322c50524546495831323a34323933313846464630352c434f444531323a32322c50524546495831333a34333532314646464630352c434f444531333a32322c50524546495831343a34333737333046464630352c434f444531343a32322c50524546495831353a34333737333146464630352c434f444531353a32322c50524546495831363a34343038313546464630352c434f444531363a32322c50524546495831373a34343038313646464630352c434f444531373a32322c50524546495831383a3434323634354646464630352c434f444531383a32322c50524546495831393a34343834323846464630352c434f444531393a32322c50524546495832303a34353537303446464630352c434f444532303a32322c50524546495832313a3435373234344646464630352c434f444532313a32322c50524546495832323a3435373335364646464630352c434f444532323a32322c50524546495832333a34363031393846464630352c434f444532333a32322c50524546495832343a34363238353746464630352c434f444532343a32322c50524546495832353a34363239353046464630352c434f444532353a32322c50524546495832363a34363337383246464630352c434f444532363a32322c50524546495832373a34363337383346464630352c434f444532373a32322c50524546495832383a34363435353446464630352c434f444532383a32322c50524546495832393a34363435353546464630352c434f444532393a32322c50524546495833303a34373135313446464630352c434f444533303a32322c50524546495833313a34373135323746464630352c434f444533313a32322c50524546495833323a34373135373246464630352c434f444533323a32322c50524546495833333a3437323433364646464630352c434f444533333a32322c50524546495833343a3437323433374646464630352c434f444533343a32322c50524546495833353a34383338393846464630352c434f444533353a32322c50524546495833363a34383338393946464630352c434f444533363a32322c50524546495833373a34383936373946464630352c434f444533373a32322c50524546495833383a34393032333746464630352c434f444533383a32322c50524546495833393a3439303234324646464630352c434f444533393a32322c50524546495834303a34393032373646464630352c434f444534303a32322c50524546495834313a34464646464646464630352c434f444534313a32322c50524546495834323a35303130303246464630382c434f444534323a31312c50524546495834333a35303130303746464630382c434f444534333a31312c50524546495834343a35303137393746464630382c434f444534343a31312c50524546495834353a35303138303346464630382c434f444534353a31312c50524546495834363a35303231313946464630392c434f444534363a31312c50524546495834373a35303231323546464630382c434f444534373a31312c50524546495834383a3530323831314646464630382c434f444534383a31312c50524546495834393a3530323934394646464630382c434f444534393a31312c50524546495835303a35303339343646464630382c434f444535303a31312c50524546495835313a35303435373446464630382c434f444535313a31312c50524546495835323a35303438393746464630382c434f444535323a31312c50524546495835333a35304646464646464630342c434f444535333a32322c50524546495835343a35313235373646464630342c434f444535343a32322c50524546495835353a35313630363746464630342c434f444535353a32322c50524546495835363a3531393234374646464630342c434f444535363a32322c50524546495835373a35314646464646464630342c434f444535373a32322c50524546495835383a35323138393346464630342c434f444535383a32322c50524546495835393a35323138393446464630342c434f444535393a32322c50524546495836303a35323234464646464630342c434f444536303a31322c50524546495836313a3532393532394646464630342c434f444536313a32322c50524546495836323a3532393533374646464630342c434f444536323a32322c50524546495836333a35324646464646464630342c434f444536333a32322c50524546495836343a35333133353746464630342c434f444536343a32342c50524546495836353a35333135363446464630342c434f444536353a32322c50524546495836363a35334646464646464630342c434f444536363a32322c50524546495836373a35343434333446464630342c434f444536373a32322c50524546495836383a35343434343746464630342c434f444536383a32322c50524546495836393a35343436333746464630342c434f444536393a32322c50524546495837303a35343436343746464630342c434f444537303a32322c50524546495837313a35343732363346464630342c434f444537313a32322c50524546495837323a35344646464646464630342c434f444537323a32322c50524546495837333a3535323431364646464630342c434f444537333a32322c50524546495837343a35353530303346464630342c434f444537343a32322c50524546495837353a35353530303546464630342c434f444537353a32322c50524546495837363a35353630353046464630342c434f444537363a32342c50524546495837373a3535363333344646464630342c434f444537373a32322c50524546495837383a3535363333364646464630342c434f444537383a32322c50524546495837393a35353832383046464630342c434f444537393a32322c50524546495838303a35354646464646464630342c434f444538303a32322c50524546495838313a35363031393246464630382c434f444538313a31312c50524546495838323a35363032323046464630382c434f444538323a31312c50524546495838333a35363032353146464630382c434f444538333a31312c50524546495838343a35363032353346464630382c434f444538343a31312c50524546495838353a35363032353446464630382c434f444538353a31312c50524546495838363a35363032353646464630382c434f444538363a31312c50524546495838373a35363032353846464630382c434f444538373a31312c50524546495838383a35363032363046464630382c434f444538383a31312c50524546495838393a35363032363146464630382c434f444538393a31312c50524546495839303a35363032363546464630382c434f444539303a31312c50524546495839313a35363032363746464630382c434f444539313a31312c50524546495839323a35363032373346464630382c434f444539323a31312c50524546495839333a35363032373946464630382c434f444539333a31312c50524546495839343a35363032393846464630382c434f444539343a31312c50524546495839353a35363032393946464630382c434f444539353a31312c50524546495839363a3537393838334646464630382c434f444539363a31312c50524546495839373a3537393838364646464630382c434f444539373a31312c50524546495839383a35373938393146464630382c434f444539383a31312c50524546495839393a35373938393846464630382c434f444539393a31312c5052454649583130303a35373939304646464630382c434f44453130303a31312c5052454649583130313a35373939313246464630382c434f44453130313a31312c5052454649583130323a35373939313446464630382c434f44453130323a31312c5052454649583130333a35373939323346464630382c434f44453130333a31312c5052454649583130343a35373939323846464630382c434f44453130343a31312c5052454649583130353a35373939333146464630382c434f44453130353a31312c5052454649583130363a35373939333246464630382c434f44453130363a31312c5052454649583130373a35373939333446464630382c434f44453130373a31312c5052454649583130383a35373939333546464630382c434f44453130383a31312c5052454649583130393a35373939333946464630382c434f44453130393a31312c5052454649583131303a35373939343246464630382c434f44453131303a31312c5052454649583131313a35373939343646464630382c434f44453131313a31312c5052454649583131323a35373939353446464630382c434f44453131323a31312c5052454649583131333a35373939373246464630382c434f44453131333a31312c5052454649583131343a35373939373346464630382c434f44453131343a31312c5052454649583131353a35373939373446464630382c434f44453131353a31312c5052454649583131363a35373939383346464630342c434f44453131363a32322c5052454649583131373a35373939383846464630382c434f44453131373a31312c5052454649583131383a35373939383946464630382c434f44453131383a31312c5052454649583131393a35373939393046464630382c434f44453131393a31312c5052454649583132303a35373939393346464630382c434f44453132303a31312c5052454649583132313a35373939393446464630382c434f44453132313a31312c5052454649583132323a35373939393546464630382c434f44453132323a31312c5052454649583132333a35373939393946464630382c434f44453132333a31312c5052454649583132343a35383136393646464630382c434f44453132343a31312c5052454649583132353a35383136393746464630382c434f44453132353a31312c5052454649583132363a35383136393846464630382c434f44453132363a31312c5052454649583132373a35383136393946464630382c434f44453132373a31312c5052454649583132383a35383138303146464630382c434f444531}</jsontext></terminalConnectionResponse>");
	}
	if(testmsg == 1 ) {
strcpy(resp,"<?xml version=\"1.0\"?>");
strcat(resp,"<terminalConnectionResponse>");
strcat(resp,"<serialNumber>00</serialNumber>");
strcat(resp,"<model>TEST</model>");
strcat(resp,"<NextMsg>1</NextMsg>\n");
strcat(resp,"<jsontext>{TYPE:FILE_PART,NEXTMSG:1,NAME:CPAT_TEST,INDEX:001,ENCODE:HEX,DATA:32383a31312c5052454649583132393a35383138313046464630382c434f44453132393a31312c5052454649583133303a35383138313146464630382c434f44453133303a31312c5052454649583133313a35383138313246464630382c434f44453133313a31312c5052454649583133323a35383138313346464630382c434f44453133323a31312c5052454649583133333a35383138313446464630382c434f44453133333a31312c5052454649583133343a35383138353546464630382c434f44453133343a31312c5052454649583133353a35383430304646464630382c434f44453133353a31312c5052454649583133363a35383631393546464630382c434f44453133363a31312c5052454649583133373a35383835393546464630382c434f44453133373a31312c5052454649583133383a35383836373046464630382c434f44453133383a31312c5052454649583133393a35383839393446464630382c434f44453133393a31312c5052454649583134303a35383932363446464630382c434f44453134303a31312c5052454649583134313a35383932383046464630382c434f44453134313a31312c5052454649583134323a35383935333646464630382c434f44453134323a31312c5052454649583134333a35383935353446464630382c434f44453134333a31312c5052454649583134343a35383935353546464630382c434f44453134343a31312c5052454649583134353a35383935353646464630382c434f44453134353a31312c5052454649583134363a35383936343946464630382c434f44453134363a31312c5052454649583134373a35383938363846464630382c434f44453134373a31312c5052454649583134383a36303031353046464630382c434f44453134383a31312c5052454649583134393a36303131304646464630322c434f44453134393a32342c5052454649583135303a36303131324646464630322c434f44453135303a32342c5052454649583135313a36303131334646464630322c434f44453135313a32342c5052454649583135323a36303131344646464630322c434f44453135323a32342c5052454649583135333a36303131373446464630322c434f44453135333a32342c5052454649583135343a36303131373746464630322c434f44453135343a32342c5052454649583135353a36303131373846464630322c434f44453135353a32342c5052454649583135363a36303131373946464630322c434f44453135363a32342c5052454649583135373a36303131384646464630322c434f44453135373a32342c5052454649583135383a36303131394646464630322c434f44453135383a32342c5052454649583135393a36303133333546464630382c434f44453135393a31312c5052454649583136303a36303146464646464630382c434f44453136303a31312c5052454649583136313a36303338343146464630392c434f44453136313a31312c5052454649583136323a36323230343546464630382c434f44453136323a31312c5052454649583136333a36323230373846464630382c434f44453136333a31312c5052454649583136343a36323830303046464630382c434f44453136343a31312c5052454649583136353a36333638383746464630382c434f44453136353a31312c5052454649583136363a36333638383846464630382c434f44453136363a31312c5052454649583136373a36333638383946464630382c434f44453136373a31312c5052454649583136383a36333638393046464630382c434f44453136383a31312c5052454649583136393a36333638393146464630382c434f44453136393a31312c5052454649583137303a36333638393246464630382c434f44453137303a31312c5052454649583137313a36333638393446464630382c434f44453137313a31312c5052454649583137323a36333935333546464630382c434f44453137323a31312c5052454649583137333a36344646464646464630322c434f44453137333a32342c5052454649583137343a36354646464646464630322c434f44453137343a32342c5052454649583137353a36464646464646464630382c434f44453137353a31312c7d}</jsontext> </terminalConnectionResponse>"); 
	}
	if(testmsg == 2 ) {
strcpy(resp,"<?xml version=\"1.0\"?>");
strcat(resp,"<terminalConnectionResponse>");
strcat(resp,"<serialNumber>00</serialNumber>");
strcat(resp,"<model>TEST</model>");
strcat(resp,"<NextMsg>1</NextMsg>");
strcat(resp,"<jsontext>{TYPE:COMBINE_FILE,NEXTMSG:0,NAME:CPAT_TEST,TOTAL:2,INDEXLEN:3}{TYPE:DISPMSG,&lt;DISPLINE_START&gt;WIDELBL,THIS,DOWNLOAD,2,C;WIDELBL,THIS,COMPLETE,3,C;&lt;DISPLINE_END&gt;}</jsontext> </terminalConnectionResponse>");
	}
	//if(testmsg>2) strcpy(resp,"<?xml version=\"1.0\"?><terminalConnectionResponse><serialNumber>00</serialNumber><model>TEST</model></terminalConnectionResponse>");

testmsg ++;
}

	if(resp && xmlresp) {
		if(strlen(resp)) iret = unpackXmlFromPortal( resp,msgtype,xmlresp );
		free(resp);
	}
	return(iret);
}
